<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<!--
    Copyright (c) 2016-2022 The Linux Foundation. All rights reserved.
    Copyright (C) 2024 The RMX1971 Project
    SPDX-License-Identifier: Apache-2.0

    Audio policy configuration with Dolby Atmos integration for RMX1971.
-->
<audioPolicyConfiguration version="7.0" xmlns:xi="http://www.w3.org/2001/XInclude">
    <globalConfiguration speaker_drc_enabled="true" call_screen_mode_supported="true"/>

    <modules>
        <!-- Primary Audio HAL -->
        <module name="primary" halVersion="2.0">
            <attachedDevices>
                <item>Earpiece</item>
                <item>Speaker</item>
                <item>Telephony Tx</item>
                <item>Built-In Mic</item>
                <item>Built-In Back Mic</item>
                <item>Telephony Rx</item>
            </attachedDevices>
            <defaultOutputDevice>Speaker</defaultOutputDevice>
            <mixPorts>
                <!-- TWEAK: Added 'dap' effect to primary and deep_buffer outputs -->
                <mixPort name="primary output" role="source" flags="AUDIO_OUTPUT_FLAG_FAST AUDIO_OUTPUT_FLAG_PRIMARY">
                    <profile name="" format="AUDIO_FORMAT_PCM_16_BIT"
                             samplingRates="48000" channelMasks="AUDIO_CHANNEL_OUT_STEREO"/>
                    <gains>
                        <gain name="dap" mode="AUDIO_GAIN_MODE_JOINT"
                              channelMask="AUDIO_CHANNEL_OUT_STEREO"
                              minValueMB="-8000" maxValueMB="2400" defaultValueMB="0" stepValueMB="100"/>
                    </gains>
                </mixPort>
                <mixPort name="deep_buffer" role="source"
                        flags="AUDIO_OUTPUT_FLAG_DEEP_BUFFER">
                    <profile name="" format="AUDIO_FORMAT_PCM_16_BIT"
                             samplingRates="48000" channelMasks="AUDIO_CHANNEL_OUT_STEREO"/>
                    <gains>
                        <gain name="dap" mode="AUDIO_GAIN_MODE_JOINT"
                              channelMask="AUDIO_CHANNEL_OUT_STEREO"
                              minValueMB="-8000" maxValueMB="2400" defaultValueMB="0" stepValueMB="100"/>
                    </gains>
                </mixPort>
                
                <!-- Other mixPorts kept as original -->
                <mixPort name="direct_pcm" role="source" flags="AUDIO_OUTPUT_FLAG_DIRECT">
                    <profile name="" format="AUDIO_FORMAT_PCM_16_BIT"
                             samplingRates="8000 11025 12000 16000 22050 24000 32000 44100 48000 64000 88200 96000 128000 176400 192000"
                             channelMasks="AUDIO_CHANNEL_OUT_MONO AUDIO_CHANNEL_OUT_STEREO"/>
                </mixPort>
                <mixPort name="compressed_offload" role="source"
                         flags="AUDIO_OUTPUT_FLAG_DIRECT AUDIO_OUTPUT_FLAG_COMPRESS_OFFLOAD AUDIO_OUTPUT_FLAG_NON_BLOCKING">
                    <profile name="" format="AUDIO_FORMAT_MP3"
                             samplingRates="8000 11025 12000 16000 22050 24000 32000 44100 48000"
                             channelMasks="AUDIO_CHANNEL_OUT_STEREO AUDIO_CHANNEL_OUT_MONO"/>
                </mixPort>
                <mixPort name="primary input" role="sink">
                    <profile name="" format="AUDIO_FORMAT_PCM_16_BIT"
                             samplingRates="8000 11025 12000 16000 22050 24000 32000 44100 48000"
                             channelMasks="AUDIO_CHANNEL_IN_MONO AUDIO_CHANNEL_IN_STEREO AUDIO_CHANNEL_IN_FRONT_BACK"/>
                </mixPort>
            </mixPorts>

            <devicePorts>
                <!-- Output devices -->
                <devicePort tagName="Earpiece" type="AUDIO_DEVICE_OUT_EARPIECE" role="sink"/>
                <devicePort tagName="Speaker" role="sink" type="AUDIO_DEVICE_OUT_SPEAKER" address=""/>
                <devicePort tagName="Wired Headset" type="AUDIO_DEVICE_OUT_WIRED_HEADSET" role="sink"/>
                <devicePort tagName="Wired Headphones" type="AUDIO_DEVICE_OUT_WIRED_HEADPHONE" role="sink"/>

                <!-- Input devices -->
                <devicePort tagName="Built-In Mic" type="AUDIO_DEVICE_IN_BUILTIN_MIC" role="source"/>
                <devicePort tagName="Built-In Back Mic" type="AUDIO_DEVICE_IN_BACK_MIC" role="source"/>
                <devicePort tagName="Wired Headset Mic" type="AUDIO_DEVICE_IN_WIRED_HEADSET" role="source"/>
                <devicePort tagName="Telephony Rx" type="AUDIO_DEVICE_IN_TELEPHONY_RX" role="source"/>
            </devicePorts>
            <routes>
                <route type="mix" sink="Earpiece"
                       sources="primary output,deep_buffer,direct_pcm,compressed_offload"/>
                <route type="mix" sink="Speaker"
                       sources="primary output,deep_buffer,direct_pcm,compressed_offload"/>
                <route type="mix" sink="Wired Headset"
                       sources="primary output,deep_buffer,direct_pcm,compressed_offload"/>
                <route type="mix" sink="Wired Headphones"
                       sources="primary output,deep_buffer,direct_pcm,compressed_offload"/>
                <route type="mix" sink="primary input"
                       sources="Built-In Mic,Built-In Back Mic,Wired Headset Mic"/>
            </routes>

        </module>

        <!-- Other HAL Modules -->
        <xi:include href="/vendor/etc/bluetooth_audio_policy_configuration_7_0.xml"/>
        <xi:include href="/vendor/etc/hearing_aid_audio_policy_configuration_7_0.xml"/>
        <xi:include href="/vendor/etc/usbv2_audio_policy_configuration.xml"/>
        <xi:include href="/vendor/etc/r_submix_audio_policy_configuration.xml"/>
    </modules>

    <!--
        ============================================================
        Audio Effects - CRITICAL for Dolby Atmos
        ============================================================
    -->
    <effects>
        <effect name="dap" library="dap" uuid="46d279d9-9be7-453d-9d7c-ef937f675587"/>
    </effects>

    <!--
        ============================================================
        Post Processing Chains - Link effects to audio streams
        ============================================================
    -->
    <postprocess>
        <stream type="music">
            <apply effect="dap"/>
        </stream>
        <stream type="ring">
            <apply effect="dap"/>
        </stream>
        <stream type="alarm">
            <apply effect="dap"/>
        </stream>
        <stream type="notification">
            <apply effect="dap"/>
        </stream>
        <stream type="system">
            <apply effect="dap"/>
        </stream>
    </postprocess>

    <!-- Volume section (imported) -->
    <xi:include href="/vendor/etc/audio_policy_volumes.xml"/>
    <xi:include href="/vendor/etc/default_volume_tables.xml"/>
</audioPolicyConfiguration>