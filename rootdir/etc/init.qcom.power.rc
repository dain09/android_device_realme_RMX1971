#
# Copyright (c) 2016, Code Aurora Forum. All rights reserved.
# Organized and tweaked for RMX1971.
#

# --- Early Boot Initializations ---
# Applied as soon as the init process starts.
on early-init
    # Enable scheduler boosting for faster boot times. This is turned off later.
    write /proc/sys/kernel/sched_boost 1

# --- Core Initializations ---
# Applied after the filesystem is mounted but before boot is complete.
on init
    # Configure SchedTune for task prioritization
    write /dev/stune/foreground/schedtune.sched_boost_no_override 1
    write /dev/stune/top-app/schedtune.sched_boost_no_override 1
    write /dev/stune/top-app/schedtune.colocate 1

    # Set RTC to wake the system from suspend
    write /sys/module/qpnp_rtc/parameters/poweron_alarm 1

on boot
    # Disable console suspend for better kernel crash logging
    write /sys/module/printk/parameters/console_suspend N

    # Disable scheduler autogrouping for potential UI responsiveness improvements
    write /proc/sys/kernel/sched_autogroup_enabled 0


# --- Charger Mode Specific Configuration ---
# Applied only when the device is booting in charger mode.
on property:init.svc.vendor.charger=running
    # Keep only one LITTLE and one big core online to save power
    write /sys/devices/system/cpu/cpu1/online 0
    write /sys/devices/system/cpu/cpu2/online 0
    write /sys/devices/system/cpu/cpu3/online 0
    write /sys/devices/system/cpu/cpu4/online 0
    write /sys/devices/system/cpu/cpu5/online 0
    write /sys/devices/system/cpu/cpu7/online 0

    # Turn on all power saving features during charge
    write /sys/module/lpm_levels/parameters/sleep_disabled 0
    write /sys/devices/platform/soc/${ro.boot.bootdevice}/clkgate_enable 1
    write /sys/devices/platform/soc/${ro.boot.bootdevice}/hibern8_on_idle_enable 1

    # Start the thermal engine to manage heat
    start vendor.thermal-engine


# --- Post-Boot Performance & Power Tuning ---
# These settings are applied once the system has fully booted.
on property:sys.boot_completed=1
    # Enable PowerHAL hint processing
    setprop vendor.powerhal.init 1

    # Configure SchedTune for normal operation
    write /dev/stune/foreground/schedtune.prefer_idle 1
    write /dev/stune/top-app/schedtune.boost 10
    write /dev/stune/top-app/schedtune.prefer_idle 1

    # Set CPUsets for different task groups
    write /dev/cpuset/background/cpus 4-5
    write /dev/cpuset/system-background/cpus 2-5
    write /dev/cpuset/foreground/cpus 0-5,7
    write /dev/cpuset/top-app/cpus 0-7

    # Configure CPU governor settings (schedutil)
    write /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor "schedutil"
    write /sys/devices/system/cpu/cpu0/cpufreq/schedutil/up_rate_limit_us 0
    write /sys/devices/system/cpu/cpu0/cpufreq/schedutil/down_rate_limit_us 0
    write /sys/devices/system/cpu/cpu0/cpufreq/schedutil/hispeed_freq 1209600
    write /sys/devices/system/cpu/cpu0/cpufreq/scaling_min_freq 576000

    write /sys/devices/system/cpu/cpu6/cpufreq/scaling_governor "schedutil"
    write /sys/devices/system/cpu/cpu6/cpufreq/schedutil/up_rate_limit_us 0
    write /sys/devices/system/cpu/cpu6/cpufreq/schedutil/down_rate_limit_us 0
    write /sys/devices/system/cpu/cpu6/cpufreq/schedutil/hispeed_freq 1344000
    write /sys/devices/system/cpu/cpu6/cpufreq/scaling_min_freq 652800

    # Configure scheduler parameters for big.LITTLE
    write /proc/sys/kernel/sched_upmigrate 96
    write /proc/sys/kernel/sched_downmigrate 90

    # Configure input boost on touch
    write /sys/module/cpu_boost/parameters/input_boost_freq "0:1209600"
    write /sys/module/cpu_boost/parameters/input_boost_ms 40

    # Configure memory bandwidth and latency governors (devfreq)
    write /sys/class/devfreq/soc:qcom,cpubw/governor "bw_hwmon"
    write /sys/class/devfreq/soc:qcom,cpubw/polling_interval 50
    write /sys/class/devfreq/soc:qcom,cpubw/bw_hwmon/io_percent 68

    write /sys/class/devfreq/soc:qcom,memlat-cpu0/governor "mem_latency"
    write /sys/class/devfreq/soc:qcom,memlat-cpu0/polling_interval 10
    write /sys/class/devfreq/soc:qcom,memlat-cpu0/mem_latency/ratio_ceil 400

    write /sys/class/devfreq/soc:qcom,memlat-cpu6/governor "mem_latency"
    write /sys/class/devfreq/soc:qcom,memlat-cpu6/polling_interval 10
    write /sys/class/devfreq/soc:qcom,memlat-cpu6/mem_latency/ratio_ceil 400

    write /sys/class/devfreq/soc:qcom,mincpubw/governor "cpufreq"

    # Turn on all power saving features
    write /sys/module/lpm_levels/parameters/sleep_disabled 0
    write /sys/devices/platform/soc/${ro.boot.bootdevice}/clkgate_enable 1
    write /sys/devices/platform/soc/${ro.boot.bootdevice}/hibern8_on_idle_enable 1

    # Disable the boot-time scheduler boost
    write /proc/sys/kernel/sched_boost 0