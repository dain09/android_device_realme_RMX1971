#
# Copyright (c) 2013-2018, The Linux Foundation. All rights reserved.
# Heavily tweaked and organized for RMX1971.
#

# --- Filesystem & Early Boot ---
on fs
    wait /dev/block/platform/soc/${ro.boot.bootdevice}
    symlink /dev/block/platform/soc/${ro.boot.bootdevice} /dev/block/bootdevice
    mount_all /vendor/etc/fstab.qcom --early
    chown root system /mnt/vendor/persist
    chmod 0771 /mnt/vendor/persist
    restorecon_recursive /mnt/vendor/persist
    mkdir /mnt/vendor/persist/data 0700 system system

on post-fs
    # set RLIMIT_MEMLOCK to 64MB
    setrlimit 8 67108864 67108864
    # Enable IPA hardware acceleration
    write /dev/ipa 1

on late-fs
    mount_all /vendor/etc/fstab.qcom --late

on post-fs-data
    mkdir /data/vendor/nnhal 0700 system system


# --- Boot-time Permissions & Properties ---
on boot
    # Regionalization permissions
    chmod 0644 /persist/speccfg/spec
    chown system system /persist/speccfg/spec
    # ... (other chmod/chown for speccfg can be kept if needed)

    # USB controller configuration
    setprop vendor.usb.rndis.func.name "gsi"
    setprop vendor.usb.rmnet.func.name "gsi"
    setprop vendor.usb.rmnet.inst.name "rmnet"

    # Notification LED permissions
    chown system system /sys/class/leds/red/blink
    chown system system /sys/class/leds/green/blink
    chown system system /sys/class/leds/blue/blink

    # Start core Qualcomm services
    start rmt_storage
    start rfs_access


# --- Core HALs & Services ---
# Peripheral Manager
service vendor.per_mgr /vendor/bin/pm-service
    class core
    user system
    group system
    ioprio rt 4

service vendor.per_proxy /vendor/bin/pm-proxy
    class core
    user system
    group system
    disabled

on property:init.svc.vendor.per_mgr=running
    start vendor.per_proxy

on property:sys.shutdown.requested=*
    stop vendor.per_proxy

# PD Mapper
service vendor.pd_mapper /vendor/bin/pd-mapper
    class core
    user system
    group system

# Thermal Engine
service thermal-engine /system/vendor/bin/thermal-engine
   class main
   user root
   group root
   socket thermal-send-client stream 0666 system system
   socket thermal-recv-client stream 0660 system system

# Post-processing Daemon
service ppd /vendor/bin/mm-pp-dpps
    class late_start
    user system
    group system graphics
    socket pps stream 0660 system system
    disabled

on property:init.svc.vendor.hwcomposer-2-3=running
    start ppd
on property:init.svc.zygote=running
    start ppd

on property:init.svc.vendor.hwcomposer-2-3=stopped
    stop ppd
on property:init.svc.zygote=stopped
    stop ppd


# --- Charger Mode ---
on charger
    start vendor.power_off_alarm


#========================================
# Performance & Kernel Tweaks
# This section executes after the phone has fully booted.
#========================================
on property:sys.boot_completed=1
    # --- CPU Governor Tweaks ---
    # Set governor to 'schedutil' for a modern balance of
    # performance on-demand and battery saving at idle.
    write /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor "schedutil"
    write /sys/devices/system/cpu/cpu4/cpufreq/scaling_governor "schedutil"

    # --- I/O Scheduler Tweaks ---
    # Set the I/O scheduler to 'mq-deadline' for better read/write performance,
    # leading to faster app launches and a snappier UI.
    write /sys/block/sda/queue/scheduler "mq-deadline"
    write /sys/block/sdb/queue/scheduler "mq-deadline"
    write /sys/block/sdc/queue/scheduler "mq-deadline"
    write /sys/block/sdd/queue/scheduler "mq-deadline"

    # --- Network Tweaks ---
    # Set TCP Congestion Algorithm to 'westwood' for better performance
    # on wireless and lossy networks.
    write /proc/sys/net/ipv4/tcp_congestion_control "westwood"