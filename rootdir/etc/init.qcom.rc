#
# Copyright (c) 2009-2020, The Linux Foundation. All rights reserved.
# Main init script for RMX1971, organized and tweaked.
#

# --- Import Sub-Scripts ---
# Imports other specific init scripts. This should be at the top.
import /vendor/etc/init/hw/init.oppo.rc
import /vendor/etc/init/hw/init.qcom.power.rc
import /vendor/etc/init/hw/init.qcom.usb.rc
import /vendor/etc/init/hw/init.target.rc
import /vendor/etc/init/hw/init.RealmeParts.rc
import /vendor/etc/init/hw/init.oppo.vendor.motor.rc


# --- Early Initialization ---
# Runs as soon as init starts, before most filesystems are mounted.
on early-init
    mount debugfs debugfs /sys/kernel/debug
    chmod 0755 /sys/kernel/debug

    # Set permissions for GPU recovery and debugging
    chown system graphics /sys/class/drm/card0/device/power/control
    chown system graphics /sys/kernel/debug/dri/0/debug/dump
    chown system graphics /sys/kernel/debug/sync/sw_sync
    chmod 0666 /sys/kernel/debug/sync/sw_sync


# --- Initialization ---
# Runs after early-init, but before post-fs.
on init
    # Support legacy sdcard paths
    symlink /sdcard /mnt/sdcard
    symlink /sdcard /storage/sdcard0


# --- Post Filesystem Mount ---
# Runs after filesystems are mounted.
on post-fs
    chmod 0755 /sys/kernel/debug/tracing
    mkdir /mnt/vendor/persist/wlan 0777 system system


# --- Early Boot Stage ---
# Runs after post-fs, used for starting core hardware services.
on early-boot
    # Set RLIMIT_MEMLOCK to 64MB
    setrlimit 8 67108864 67108864
    # Execute early boot shell script for QCOM hardware
    exec u:r:vendor_qti_init_shell:s0 -- /vendor/bin/init.qcom.early_boot.sh


# --- Main Boot Stage ---
# Runs after early-boot. Sets up most system properties and permissions.
on boot
    # Bluetooth permissions
    chown bluetooth bluetooth /sys/module/bluetooth_power/parameters/power
    chmod 0660 /sys/module/bluetooth_power/parameters/power
    chown bluetooth net_bt /sys/class/rfkill/rfkill0/state
    chmod 0660 /sys/class/rfkill/rfkill0/state

    # RIL (Telephony) services and sockets
    mkdir /dev/socket/qmux_radio 0770 radio radio
    chmod 2770 /dev/socket/qmux_radio
    enable vendor.qcrild
    enable vendor.qcrild2

    # Set TCP buffer settings
    setprop net.tcp.2g_init_rwnd 10
    write /proc/sys/net/netfilter/nf_conntrack_tcp_be_liberal 1

    # --- CRITICAL: Oppo/Realme Display & Touch Control Permissions ---
    # These are vital for display features and potentially fixing touch issues.
    chown system system /sys/kernel/oppo_display/hbm
    chown system system /sys/kernel/oppo_display/seed
    chown system system /sys/kernel/oppo_display/dimlayer_bl_en
    chown system system /sys/kernel/oppo_display/ffl_set
    chown system system /sys/kernel/oppo_display/dump_info
    chown system system /sys/kernel/oppo_display/esd_status
    chown system system /sys/kernel/oppo_display/power_status
    chown system system /sys/kernel/oppo_display/dimlayer_hbm
    chown system system /sys/kernel/oppo_display/notify_fppress
    chown system system /sys/kernel/oppo_display/force_screenfp
    chown system system /sys/kernel/oppo_display/sau_closebl_node
    chown system system /sys/kernel/oppo_display/panel_serial_number
    chown system system /sys/kernel/oppo_display/aod_light_mode_set
    chown system system /sys/kernel/oppo_display/LCM_CABC

    chmod 0666 /sys/kernel/oppo_display/hbm
    chmod 0666 /sys/kernel/oppo_display/seed
    chmod 0666 /sys/kernel/oppo_display/dimlayer_bl_en
    chmod 0666 /sys/kernel/oppo_display/ffl_set
    chmod 0666 /sys/kernel/oppo_display/dump_info
    chmod 0666 /sys/kernel/oppo_display/esd_status
    chmod 0666 /sys/kernel/oppo_display/power_status
    chmod 0666 /sys/kernel/oppo_display/dimlayer_hbm
    chmod 0666 /sys/kernel/oppo_display/notify_fppress
    chmod 0666 /sys/kernel/oppo_display/force_screenfp
    chmod 0666 /sys/kernel/oppo_display/sau_closebl_node
    chmod 0666 /sys/kernel/oppo_display/panel_serial_number
    chmod 0666 /sys/kernel/oppo_display/aod_light_mode_set
    chmod 0666 /sys/kernel/oppo_display/LCM_CABC


# --- Post-FS Data Stage ---
# Runs after the /data partition is mounted. Creates data directories.
on post-fs-data
    # Misc
    mkdir /data/vendor/misc 01771 system system
    # Display
    mkdir /data/vendor/display 0770 system graphics
    # Media
    mkdir /data/vendor/media 0770 mediacodec media
    # Camera
    mkdir /data/vendor/camera 0770 camera camera
    # Wi-Fi
    mkdir /data/vendor/wifi 0770 wifi wifi
    mkdir /data/vendor/wifi/sockets 0770 wifi wifi
    # Audio
    mkdir /data/vendor/audio 0770 audio audio
    # Radio / Modem
    mkdir /data/vendor/radio 0770 system radio
    mkdir /data/vendor/modem_config 0570 radio root
    # Location
    mkdir /data/vendor/location 0770 gps gps
    # Time
    mkdir /data/vendor/time/ 0700 system system

    setprop vold.post_fs_data_done 1


# --- Boot Completed Stage ---
# Runs after the system has fully booted up. Ideal for final tweaks.
on property:sys.boot_completed=1
    # Stop the boot animation
    stop bootanim

    # Start post-boot shell script for QCOM hardware
    start qcom-post-boot

    # Re-initialize LMKD with new properties
    setprop lmkd.reinit 1

    # --- I/O Scheduler Tweak ---
    # Set the I/O scheduler to 'mq-deadline' for better read/write performance.
    write /sys/block/dm-0/queue/scheduler "mq-deadline"
    write /sys/block/dm-1/queue/scheduler "mq-deadline"

    # --- Network Tweak ---
    # Set TCP Congestion Algorithm to 'westwood' for better performance.
    write /proc/sys/net/ipv4/tcp_congestion_control "westwood"

    # Restrict permissions to socket file to hide Magisk & co.
    chmod 440 /proc/net/unix


# --- Various Services ---
# These are started by other parts of the system when needed.
service qcom-sh /vendor/bin/init.qcom.sh
    class late_start
    user root
    group root system radio
    oneshot

service qcom-post-boot /vendor/bin/init.qcom.post_boot.sh
    class late_start
    user root
    group root system wakelock graphics
    disabled
    oneshot

service charger /system/bin/charger
    class charger
    user system
    group system graphics input
    capabilities SYS_BOOT
    seclabel u:r:charger:s0

service vendor.power_off_alarm /vendor/bin/power_off_alarm
    class core
    group system
    disabled
    oneshot

# Audio HAL
service vendor.audio-hal /vendor/bin/hw/android.hardware.audio.service
    override
    class hal
    user audioserver
    group audio camera drmrpc inet media mediadrm net_bt net_bt_admin net_bw_acct oem_2901 wakelock
    capabilities BLOCK_SUSPEND SYS_NICE
    rlimit rtprio 10 10
    task_profiles ProcessCapacityHigh HighPerformance
    onrestart restart audioserver